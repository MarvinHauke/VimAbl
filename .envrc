# Automatically activate the uv-managed virtual environment
# Create .venv if it doesn't exist
if [ ! -d ".venv" ]; then
    log_status "Creating virtual environment with uv..."
    uv sync
fi

# Activate the virtual environment
source .venv/bin/activate

# Export project root for convenience
export PROJECT_ROOT="$(pwd)"

# Add scripts directory to PATH (for future scripts)
export PATH="$PROJECT_ROOT/scripts:$PATH"

# Environment variables for development
export VIMABL_ENV="development"

# WebSocket server defaults
export VIMABL_WS_HOST="${VIMABL_WS_HOST:-localhost}"
export VIMABL_WS_PORT="${VIMABL_WS_PORT:-8765}"

# Remote Script socket defaults
export VIMABL_REMOTE_PORT="${VIMABL_REMOTE_PORT:-9001}"

# Ableton paths (macOS)
export ABLETON_USER_LIBRARY="$HOME/Music/Ableton/User Library"
export ABLETON_REMOTE_SCRIPTS="$ABLETON_USER_LIBRARY/Remote Scripts"

# Enable verbose logging for development
export PYTHONVERBOSE="${PYTHONVERBOSE:-0}"

# Ensure UTF-8 encoding
export PYTHONIOENCODING="utf-8"

# Load local overrides if they exist (not committed to git)
if [ -f ".envrc.local" ]; then
    source_env ".envrc.local"
fi

# Log to terminal when direnv activates
log_status "VimAbl development environment activated"
log_status "Python: $(python --version 2>&1)"
log_status "Virtual env: .venv"
log_status "WebSocket: ws://${VIMABL_WS_HOST}:${VIMABL_WS_PORT}"
